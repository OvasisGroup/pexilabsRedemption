{% extends 'checkout/checkout_layout.html' %}

{% block page_header %}PexiPay | Checkout{% endblock %}

{% block content %}
<!-- Header with Logo and Back Button -->
<div class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <!-- Logo -->
            <div class="flex-shrink-0" style="background-color: black; padding: 10px; border-radius: 10px;">
                <img class="h-8 sm:h-10 w-auto" src="https://www.pexipay.com/_next/image?url=%2Fimages%2Fpexi_logo.png&w=256&q=75" alt="PexiPay">
            </div>
            
            <a href="/" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                <i class="fas fa-arrow-left mr-2"></i>
                <span class="hidden sm:inline">Back</span>
            </a>
        </div>
    </div>
</div>

<div class="min-h-screen flex flex-col lg:flex-row bg-gradient-to-br from-gray-50 to-blue-50">
    <!-- Left Sidebar - Order Summary -->
    <div class="w-full lg:w-2/5 order-summary bg-white shadow-xl order-2 lg:order-1">
        <div class="p-4 sm:p-6 lg:p-12 h-full">
            
            <!-- Order Summary -->
            <div class="mb-6 sm:mb-8">
                <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center">
                    <i class="fas fa-receipt text-blue-600 mr-2 sm:mr-3 text-sm sm:text-base"></i>
                    Order Summary
                </h2>
                
                <div class="bg-gray-50 rounded-xl p-4 sm:p-6 space-y-3 sm:space-y-4">
                    <div class="flex justify-between items-start py-2 sm:py-3">
                        <div class="flex-1 pr-2">
                            <p class="font-semibold text-gray-900 text-base sm:text-lg break-words">{{ description }}</p>
                            <p class="text-xs sm:text-sm text-gray-500 mt-1">Payment for services</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="font-bold text-gray-900 text-base sm:text-lg">{{ currency }} {{ amount }}</p>
                        </div>
                    </div>
                    
                    <hr class="border-gray-200">
                    
                    <div class="flex justify-between items-center py-1 sm:py-2">
                        <p class="text-gray-600 text-sm sm:text-base">Subtotal</p>
                        <p class="text-gray-900 font-medium text-sm sm:text-base">{{ currency }} {{ amount }}</p>
                    </div>
                    
                    <div class="flex justify-between items-center py-1 sm:py-2">
                        <p class="text-gray-600 text-sm sm:text-base">Processing fee</p>
                        <p class="text-green-600 font-medium text-sm sm:text-base">{{ currency }} 0.00</p>
                    </div>
                    
                    <hr class="border-gray-300">
                    
                    <div class="flex justify-between items-center py-2 sm:py-3 bg-blue-50 rounded-lg px-3 sm:px-4">
                        <p class="text-base sm:text-lg font-bold text-gray-900">Total</p>
                        <p class="text-lg sm:text-xl font-bold text-blue-600">{{ currency }} {{ amount }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Security Notice -->
            <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-xl p-4 sm:p-5">
                <div class="flex items-start">
                    <div class="bg-green-100 rounded-full p-1.5 sm:p-2 mr-3 sm:mr-4 flex-shrink-0">
                        <i class="fas fa-shield-alt text-green-600 text-sm sm:text-base"></i>
                    </div>
                    <div class="min-w-0">
                        <p class="text-xs sm:text-sm font-semibold text-green-900">256-bit SSL Encryption</p>
                        <p class="text-xs text-green-700 mt-1">Your payment information is protected with bank-level security</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Main Area - Payment Form -->
    <div class="w-full lg:w-3/5 payment-form relative overflow-hidden order-1 lg:order-2 min-h-[50vh] lg:min-h-screen">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-5">
            <div class="absolute inset-0" style="background-image: radial-gradient(circle at 1px 1px, rgba(59, 130, 246, 0.3) 1px, transparent 0); background-size: 20px 20px;"></div>
        </div>
        
        <div class="relative z-10 p-4 sm:p-6 lg:p-12 h-full">
            <!-- Header -->
            <div class="mb-6 sm:mb-8">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Payment Details</h1>
                </div>
                <p class="text-base sm:text-lg text-gray-600">Complete your purchase by providing your payment details</p>
            </div>
            
            <!-- Payment Form -->
            <form id="payment-form" class="space-y-6 sm:space-y-8">
                <!-- Customer Information -->
                <div class="bg-white rounded-2xl p-4 sm:p-6 lg:p-8 shadow-lg border border-gray-100">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center">
                        <div class="bg-blue-100 rounded-full p-1.5 sm:p-2 mr-2 sm:mr-3">
                            <i class="fas fa-user text-blue-600 text-sm sm:text-base"></i>
                        </div>
                        Contact Information
                    </h3>
                    
                    <div class="space-y-4 sm:space-y-6">
                        <div>
                            <label for="customer-email" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">Email Address</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-envelope text-gray-400 text-sm"></i>
                                </div>
                                <input type="email" id="customer-email" name="email" value="{{ customer_email }}" 
                                       class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500 text-sm sm:text-base" 
                                       placeholder="Enter your email address">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                            <div>
                                <label for="customer-first-name" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">First Name</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-user text-gray-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="customer-first-name" name="first_name" value="Test" 
                                           class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500 text-sm sm:text-base" 
                                           placeholder="First name">
                                </div>
                            </div>
                            <div>
                                <label for="customer-last-name" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">Last Name</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-user text-gray-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="customer-last-name" name="last_name" value="User" 
                                           class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500 text-sm sm:text-base" 
                                           placeholder="Last name">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="customer-phone" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">Phone Number</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-phone text-gray-400 text-sm"></i>
                                </div>
                                <input type="tel" id="customer-phone" name="phone" value="+254700000000" 
                                       class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500 text-sm sm:text-base" 
                                       placeholder="Enter your phone number">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Details -->
                <div class="bg-white rounded-2xl p-4 sm:p-6 lg:p-8 shadow-lg border border-gray-100">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center">
                        <div class="bg-green-100 rounded-full p-1.5 sm:p-2 mr-2 sm:mr-3">
                            <i class="fas fa-dollar-sign text-green-600 text-sm sm:text-base"></i>
                        </div>
                        Payment Details
                    </h3>
                    
                    <div class="space-y-4 sm:space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                            <div>
                                <label for="payment-currency" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">Currency</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-coins text-gray-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="payment-currency" name="currency" value="{{ currency }}" 
                                           class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl bg-gray-50 text-gray-900 cursor-not-allowed text-sm sm:text-base" 
                                           placeholder="Currency" readonly>
                                </div>
                            </div>
                            <div>
                                <label for="payment-amount" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">Amount</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-money-bill-wave text-gray-400 text-sm"></i>
                                    </div>
                                    <input type="number" id="payment-amount" name="amount" value="{{ amount }}" 
                                           class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl bg-gray-50 text-gray-900 cursor-not-allowed font-semibold text-sm sm:text-base" 
                                           placeholder="Amount" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="payment-description" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">Description</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-file-alt text-gray-400 text-sm"></i>
                                </div>
                                <input type="text" id="payment-description" name="description" value="{{ description }}" 
                                       class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl bg-gray-50 text-gray-900 cursor-not-allowed text-sm sm:text-base" 
                                       placeholder="Payment description" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                            
                <!-- Billing Address -->
                <div class="bg-white rounded-2xl p-4 sm:p-6 lg:p-8 shadow-lg border border-gray-100">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center">
                        <div class="bg-purple-100 rounded-full p-1.5 sm:p-2 mr-2 sm:mr-3">
                            <i class="fas fa-map-marker-alt text-purple-600 text-sm sm:text-base"></i>
                        </div>
                        Billing Address
                    </h3>
                    
                    <div class="space-y-4 sm:space-y-6">
                        <div>
                            <label for="address-line1" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">Street Address</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-home text-gray-400 text-sm"></i>
                                </div>
                                <input type="text" id="address-line1" name="address_line1" value="Test Address Line 1" 
                                       class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500 text-sm sm:text-base" 
                                       placeholder="Street address">
                            </div>
                        </div>
                        
                        <div>
                            <label for="address-line2" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">Address Line 2 (Optional)</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-building text-gray-400 text-sm"></i>
                                </div>
                                <input type="text" id="address-line2" name="address_line2" value="" 
                                       class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500 text-sm sm:text-base" 
                                       placeholder="Apartment, suite, etc. (optional)">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                            <div>
                                <label for="address-city" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">City</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-city text-gray-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="address-city" name="address_city" value="Nairobi" 
                                           class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500 text-sm sm:text-base" 
                                           placeholder="City">
                                </div>
                            </div>
                            <div>
                                <label for="address-postcode" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">Postal Code</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-mail-bulk text-gray-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="address-postcode" name="address_postcode" value="00100" 
                                           class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500 text-sm sm:text-base" 
                                           placeholder="Postal code">
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                            <div>
                                <label for="address-state" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">State/Province</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-map text-gray-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="address-state" name="address_state" value="Nairobi" 
                                           class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500 text-sm sm:text-base" 
                                           placeholder="State/Province">
                                </div>
                            </div>
                            <div>
                                <label for="address-country" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2 sm:mb-3">Country</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-globe text-gray-400 text-sm"></i>
                                    </div>
                                    <select id="address-country" name="address_country" 
                                            class="w-full pl-10 pr-4 py-3 sm:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 appearance-none bg-white text-sm sm:text-base">
                                        <option value="KE" selected>Kenya</option>
                                        <option value="US">United States</option>
                                        <option value="GB">United Kingdom</option>
                                        <option value="CA">Canada</option>
                                        <option value="AU">Australia</option>
                                        <option value="DE">Germany</option>
                                        <option value="FR">France</option>
                                        <option value="NG">Nigeria</option>
                                        <option value="ZA">South Africa</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                        <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                
                
                <!-- Create Payment Intent Button -->
                <div class="pt-4 sm:pt-6">
                    <button type="button" onclick="createPaymentIntent()" 
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-2xl font-bold text-base sm:text-lg hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-offset-2 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                            id="create-intent-btn">
                        <span class="flex items-center justify-center">
                            <i class="fas fa-shield-alt mr-3"></i>
                            Process Secure Payment
                        </span>
                    </button>
                    
                    <div class="bg-green-50 border border-green-200 rounded-xl p-3 sm:p-4 mt-4 sm:mt-6">
                        <div class="flex items-center justify-center text-xs sm:text-sm text-green-800 mb-2">
                            <i class="fas fa-shield-check text-green-600 mr-2 text-sm"></i>
                            <span class="font-semibold">256-bit SSL Encryption</span>
                        </div>
                        <p class="text-xs text-green-700 text-center">Your payment information is encrypted and secure. We never store your card details.</p>
                        <div class="flex items-center justify-center mt-3 space-x-2 sm:space-x-4">
                            <div class="flex items-center text-xs text-green-600">
                                <i class="fas fa-check-circle mr-1"></i>
                                <span>PCI Compliant</span>
                            </div>
                            <div class="flex items-center text-xs text-green-600">
                                <i class="fas fa-check-circle mr-1"></i>
                                <span>Bank-level Security</span>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Payment Method -->
                <div class="bg-white rounded-2xl p-4 sm:p-6 lg:p-8 shadow-lg border border-gray-100">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center">
                        <div class="bg-indigo-100 rounded-full p-2 mr-3">
                            <i class="fas fa-credit-card text-indigo-600 text-sm sm:text-base"></i>
                        </div>
                        Payment Method
                    </h3>
                    
                    <!-- Payment Status -->
                    <div id="payment-status" class="hidden mb-4 sm:mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 sm:p-4">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-blue-500 mr-3 text-sm"></i>
                                <p id="payment-status-text" class="text-xs sm:text-sm font-medium text-blue-800">Initializing payment widget...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Widget Container -->
                    <div id="payment-widget-container" class="hidden">
                        <div class="bg-gray-50 rounded-2xl p-4 sm:p-6 lg:p-8 border-2 border-dashed border-gray-300">
                            <div id="paydock-payment-widget" class="min-h-[300px] sm:min-h-[400px] flex items-center justify-center">
                                <div class="text-gray-500 text-center">
                                    <div class="inline-flex items-center justify-center w-12 h-12 sm:w-16 sm:h-16 bg-blue-100 rounded-full mb-4">
                                        <i class="fas fa-spinner fa-spin text-xl sm:text-2xl text-blue-600"></i>
                                    </div>
                                    <p class="text-base sm:text-lg font-medium text-gray-700 mb-2">Loading Payment Widget</p>
                                    <p class="text-xs sm:text-sm text-gray-500">Please wait while we prepare your secure payment form...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                  <!-- Payment Widget Placeholder -->
                    <div id="widget-placeholder" class="bg-white rounded-2xl p-6 sm:p-8 lg:p-12 text-center shadow-xl border border-gray-100">
                        <div class="text-gray-500">
                            <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full mb-4 sm:mb-6">
                                <i class="fas fa-credit-card text-2xl sm:text-3xl lg:text-4xl text-blue-600"></i>
                            </div>
                            <p class="text-lg sm:text-xl font-bold text-gray-800 mb-2 sm:mb-3">Secure Payment Gateway</p>
                            <p class="text-sm sm:text-base text-gray-600 mb-4 sm:mb-6">Click "Process Payment" to load the secure payment form</p>
                            <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 text-xs sm:text-sm text-gray-500">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-lock mr-1 text-green-500"></i>
                                    SSL Encrypted
                                </div>
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-shield-alt mr-1 text-blue-500"></i>
                                    Bank Grade Security
                                </div>
                            </div>
                        </div>
                    </div>
            </form>
        </div>
        
    </div>
    
    <!-- Hidden form data -->
    <input type="hidden" id="session-id" value="{{ session_id }}">
    <input type="hidden" id="callback-url" value="{{ callback_url }}">
    <input type="hidden" id="cancel-url" value="{{ cancel_url }}">

{% endblock %}


{% block extra_js %}
     <script>
        function createPaymentIntent() {
            // Get form data
            const formData = {
                session_id: document.getElementById('session-id').value,
                currency: document.getElementById('payment-currency').value,
                amount: parseFloat(document.getElementById('payment-amount').value),
                customer: {
                    first_name: document.getElementById('customer-first-name').value,
                    last_name: document.getElementById('customer-last-name').value,
                    email: document.getElementById('customer-email').value,
                    phone: document.getElementById('customer-phone').value,
                    billing_address: {
                        address_line1: document.getElementById('address-line1').value,
                        address_line2: document.getElementById('address-line2').value,
                        address_city: document.getElementById('address-city').value,
                        address_state: document.getElementById('address-state').value,
                        address_country: document.getElementById('address-country').value,
                        address_postcode: document.getElementById('address-postcode').value
                    }
                },
                description: document.getElementById('payment-description').value,
                callback_url: document.getElementById('callback-url').value,
                cancel_url: document.getElementById('cancel-url').value
            };

            // Show loading state
            const button = document.getElementById('create-intent-btn');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Payment Intent...';

            // Create payment intent via API
            fetch('/dashboard/api/public/create-payment-intent/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    integration_type: 'uba_bank',
                    test_type: 'checkout',
                    session_id: formData.session_id,
                    amount: formData.amount,
                    currency: formData.currency,
                    customer_email: formData.customer.email,
                    description: formData.description,
                    callback_url: formData.callback_url,
                    cancel_url: formData.cancel_url
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response body:', text);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.error('Non-JSON response:', text);
                        throw new Error('Server returned non-JSON response');
                    });
                }
                
                return response.json();
            })
            .then(data => {
                if (data.status === 'success' && data.data && data.data.token) {
                    // Initialize PayDock widget with the token
                    initializePayDockWidget(data.data.token, formData);
                    
                    // Update button state
                    button.innerHTML = '<i class="fas fa-check mr-2"></i>Payment Widget Loaded';
                    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    button.classList.add('bg-green-600', 'hover:bg-green-700');
                } else {
                    throw new Error(data.error || 'Failed to create payment intent');
                }
            })
            .catch(error => {
                console.error('Error creating payment intent:', error);
                handlePaymentError('Failed to create payment intent: ' + error.message);
                
                // Reset button state
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Create Payment Intent';
            });
        }

        function initializePayDockWidget(token, formData) {
            // Hide placeholder and show widget container
            document.getElementById('widget-placeholder').classList.add('hidden');
            document.getElementById('payment-widget-container').classList.remove('hidden');
            document.getElementById('payment-status').classList.remove('hidden');
            
            const widgetContainer = document.getElementById('paydock-payment-widget');
            
            try {
                // Clear existing content
                widgetContainer.innerHTML = '';
                
                // Check if PayDock SDK is available
                if (typeof paydock === 'undefined') {
                    // Load PayDock SDK dynamically
                    const script = document.createElement('script');
                    script.src = 'https://widget.paydock.com/sdk/latest/widget.umd.js';
                    script.onload = () => {
                        createPayDockWidget(token, formData, widgetContainer);
                    };
                    script.onerror = () => {
                        widgetContainer.innerHTML = '<div class="text-red-500 p-4"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to load PayDock SDK</div>';
                    };
                    document.head.appendChild(script);
                } else {
                    createPayDockWidget(token, formData, widgetContainer);
                }
                
            } catch (error) {
                console.error('Error initializing PayDock widget:', error);
                handlePaymentError('Error loading payment widget: ' + error.message);
            }
        }

        function loadPaydockSDK() {
            console.log("%c[SDK] Loading Paydock SDK...", "color: blue");

            return new Promise((resolve, reject) => {
                if (window.paydock && typeof window.paydock.Checkout === "function") {
                    console.log("%c[SDK] Paydock SDK already loaded.", "color: green");
                    return resolve();
                }

                const script = document.createElement("script");
                script.src = "https://widget.paydock.com/sdk/latest/widget.umd.min.js";
                script.onload = () => {
                    console.log("%c[SDK] Paydock SDK loaded successfully.", "color: green");
                    if (window.paydock && typeof window.paydock.Checkout === "function") {
                        resolve();
                    } else {
                        console.error(
                            "[SDK] Paydock Checkout object not found after loading SDK.",
                            window.paydock
                        );
                        reject(
                            new Error("Paydock Checkout object not found after loading SDK.")
                        );
                    }
                };
                script.onerror = () => {
                    console.error("[SDK] Failed to load Paydock SDK.", "color: red");
                    reject(new Error("Failed to load Paydock SDK."));
                };

                document.head.appendChild(script);
            });
        }

        async function createPayDockWidget(token, formData, container) {
            try {
                await loadPaydockSDK();

                if (!window.paydock || typeof window.paydock.Checkout !== "function") {
                    handlePaymentError("Paydock SDK is not correctly loaded or is incompatible.");
                    return;
                }

                if (!token) {
                    console.error("[Widget] FATAL: Intent token missing.");
                    handlePaymentError("Payment session data is missing. Please refresh the page.");
                    return;
                }

                console.log(
                    "%c[Widget] Initializing Paydock widget with intent token: " + token,
                    "color: blue"
                );

                // Clear existing content
                container.innerHTML = '';
                
                // Create widget container
                const widgetDiv = document.createElement('div');
                widgetDiv.id = 'paydock-checkout-widget';
                widgetDiv.style.minHeight = '400px';
                container.appendChild(widgetDiv);

                // Debug: Check if Paydock object exists
                console.log("Paydock object:", window.paydock);
                console.log("Paydock Checkout constructor:", window.paydock?.Checkout);
                
                try {
                    window.kpsPaydockWidget = new window.paydock.Checkout(
                        "#paydock-checkout-widget",
                        token
                    );

                    console.log("Widget instance created:", window.kpsPaydockWidget);

                    // Set environment
                    if (typeof window.kpsPaydockWidget.setEnv === "function") {
                        window.kpsPaydockWidget.setEnv("sandbox"); // Always use sandbox for testing
                    }

                    // Handle successful payment
                    if (typeof window.kpsPaydockWidget.onPaymentSuccessful === "function") {
                        window.kpsPaydockWidget.onPaymentSuccessful(function (data) {
                            console.log("Payment successful:", data);
                            
                            // Update status
                            document.getElementById('payment-status-text').textContent = 'Payment completed successfully!';
                            document.getElementById('payment-status').className = 'mt-4 bg-green-50 border border-green-200 rounded-lg p-3';
                            document.getElementById('payment-status').querySelector('i').className = 'fas fa-check-circle text-green-500 mr-2';
                            
                            // Show success message
                            showSuccessMessage('Payment completed successfully!');

                            // Update transaction status via AJAX
                            updateTransactionStatus('completed', '', data.reference || '');
                            
                            // Redirect to callback URL if provided
                            if (formData.callback_url) {
                                setTimeout(() => {
                                    window.location.href = formData.callback_url;
                                }, 3000);
                            }
                        });
                    }

                    // Handle payment failure
                    if (typeof window.kpsPaydockWidget.onPaymentFailure === "function") {
                        window.kpsPaydockWidget.onPaymentFailure(function (error) {
                            console.error("Payment failure:", error);
                            
                            // Update transaction status via AJAX
                            updateTransactionStatus('failed', error.message || 'Payment failed', error.reference || '');
                            
                            handlePaymentError(error.message || "An error occurred during payment.");
                        });
                    }

                    // Handle payment expiration
                    if (typeof window.kpsPaydockWidget.onPaymentExpired === "function") {
                        window.kpsPaydockWidget.onPaymentExpired(function (error) {
                            console.error("Payment expired:", error);
                            
                            // Update transaction status via AJAX
                            updateTransactionStatus('expired', error.message || 'Payment session expired', error.reference || '');
                            
                            handlePaymentError(error.message || "Your payment session has expired. Please retry.");
                        });
                    }

                    // Post-initialization check to see if iframe exists after a short delay
                    setTimeout(() => {
                        const iframe = container.querySelector("iframe");
                        if (iframe) {
                            console.log(
                                "%c[Widget] SUCCESS: Iframe injected by Paydock.",
                                "color: green; font-weight: bold;"
                            );
                            document.getElementById('payment-status-text').textContent = 'Payment widget loaded successfully. Complete your payment below.';
                        } else {
                            console.error(
                                "%c[Widget] FAILURE: Iframe was NOT injected by Paydock.",
                                "color: red; font-weight: bold;"
                            );
                            console.log("Container content:", container.innerHTML);
                            handlePaymentError("Payment widget failed to load. Please refresh the page and try again.");
                        }
                    }, 3000);
                    
                } catch (widgetError) {
                    console.error("Error creating Paydock widget:", widgetError);
                    handlePaymentError("Failed to create payment widget: " + widgetError.message);
                }
                
            } catch (error) {
                console.error("[Init] Critical failure during widget init:", error);
                handlePaymentError("A critical error occurred: " + error.message);
            }
        }

        function handlePaymentError(message) {
            const container = document.getElementById('paydock-payment-widget');
            if (container) {
                container.innerHTML = `
                    <div class="text-center p-8">
                        <div class="bg-gradient-to-br from-red-50 to-pink-50 border-2 border-red-200 rounded-2xl p-8 shadow-lg">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-red-100 rounded-full mb-6">
                                <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-red-800 mb-3">Payment Error</h3>
                            <p class="text-sm text-red-700 mb-6 max-w-md mx-auto leading-relaxed">${message}</p>
                            <div class="space-y-3">
                                <button onclick="location.reload()" class="bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                    <i class="fas fa-refresh mr-2"></i>Retry Payment
                                </button>
                                <p class="text-xs text-red-600 mt-2">If the problem persists, please contact support</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Update status
            document.getElementById('payment-status-text').textContent = 'Error: ' + message;
            document.getElementById('payment-status').className = 'mt-4 bg-red-50 border border-red-200 rounded-lg p-3';
            document.getElementById('payment-status').querySelector('i').className = 'fas fa-exclamation-triangle text-red-500 mr-2';
        }

        function showSuccessMessage(message) {
            // Create success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-6 right-6 bg-gradient-to-r from-green-500 to-emerald-500 text-white px-8 py-4 rounded-2xl shadow-2xl z-50 transform transition-all duration-500 ease-out';
            notification.style.transform = 'translateX(100%)';
            notification.innerHTML = `
                <div class="flex items-center">
                    <div class="bg-white bg-opacity-20 rounded-full p-2 mr-4">
                        <i class="fas fa-check text-lg"></i>
                    </div>
                    <div>
                        <p class="font-bold text-sm">Payment Successful!</p>
                        <p class="text-xs opacity-90">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove notification after 6 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }
            }, 6000);
        }

        // Function to update transaction status via AJAX
        function updateTransactionStatus(status, failureReason = '', paymentReference = '') {
            const sessionId = formData.session_id;
            
            if (!sessionId) {
                console.error('No session ID available for transaction status update');
                return;
            }
            
            const requestData = {
                session_id: sessionId,
                status: status
            };
            
            if (failureReason) {
                requestData.failure_reason = failureReason;
            }
            
            if (paymentReference) {
                requestData.payment_reference = paymentReference;
            }
            
            fetch('/transactions/api/update-transaction-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Transaction status updated successfully:', data);
                } else {
                    console.error('Failed to update transaction status:', data.error);
                }
            })
            .catch(error => {
                console.error('Error updating transaction status:', error);
            });
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    {% endblock %}