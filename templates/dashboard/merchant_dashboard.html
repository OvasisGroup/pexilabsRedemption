{% extends 'dashboard/base_dashboard.html' %}

{% block page_header %}{{ merchant.business_name }} Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Merchant Status Banner -->
    {% if merchant.status == 'pending' %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
        <div class="flex items-center">
            <i class="fas fa-clock text-yellow-500 mr-3"></i>
            <div>
                <h3 class="text-sm font-medium text-yellow-800">Account Under Review</h3>
                <p class="text-sm text-yellow-700 mt-1">
                    Your merchant account is currently being reviewed. You'll be notified once approved.
                </p>
            </div>
        </div>
    </div>
    {% elif merchant.status == 'approved' %}
    <div class="bg-green-50 border border-green-200 rounded-xl p-4">
        <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-3"></i>
            <div>
                <h3 class="text-sm font-medium text-green-800">Account Approved</h3>
                <p class="text-sm text-green-700 mt-1">
                    Congratulations! Your merchant account has been approved. You can now start processing payments.
                </p>
            </div>
        </div>
    </div>
    {% elif merchant.status == 'active' %}
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
        <div class="flex items-center">
            <i class="fas fa-rocket text-blue-500 mr-3"></i>
            <div>
                <h3 class="text-sm font-medium text-blue-800">Account Active</h3>
                <p class="text-sm text-blue-700 mt-1">
                    Your merchant account is active and ready for business!
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Information Completeness Reminder Banner -->
    {% if not is_info_complete %}
    <div class="bg-orange-50 border border-orange-200 rounded-xl p-4">
        <div class="flex items-start">
            <i class="fas fa-exclamation-triangle text-orange-500 mr-3 mt-0.5"></i>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-orange-800">Complete Your Business Information</h3>
                <p class="text-sm text-orange-700 mt-1">
                    Some required information is missing from your account. Complete your profile to enable all features and improve verification chances.
                </p>
                <div class="mt-3">
                    <div class="text-sm text-orange-700">
                        <strong>Missing information:</strong>
                        <ul class="list-disc list-inside mt-1">
                            {% for item in missing_info %}
                            <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="mt-3 flex space-x-3">
                        <a href="{% url 'dashboard:merchant_profile' %}" 
                           class="inline-flex items-center px-3 py-2 border border-orange-300 shadow-sm text-sm leading-4 font-medium rounded-md text-orange-700 bg-orange-100 hover:bg-orange-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors">
                            <i class="fas fa-user-edit mr-2"></i>
                            Update Profile
                        </a>
                        <a href="{% url 'dashboard:merchant_bank_details' %}" 
                           class="inline-flex items-center px-3 py-2 border border-orange-300 shadow-sm text-sm leading-4 font-medium rounded-md text-orange-700 bg-orange-100 hover:bg-orange-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors">
                            <i class="fas fa-university mr-2"></i>
                            Add Bank Details
                        </a>
                    </div>
                </div>
            </div>
            <button type="button" 
                    class="ml-4 text-orange-400 hover:text-orange-600 focus:outline-none"
                    onclick="this.parentElement.parentElement.style.display = 'none'">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Transactions -->
        <div class="glass-card rounded-xl p-6 hover-lift">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-exchange-alt text-white text-sm"></i>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Total Transactions</dt>
                        <dd class="text-lg font-medium text-gray-900">{{ transaction_stats.total }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Success Rate -->
        <div class="glass-card rounded-xl p-6 hover-lift">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-white text-sm"></i>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Success Rate</dt>
                        <dd class="text-lg font-medium text-gray-900">{{ transaction_stats.success_rate|floatformat:1 }}%</dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Total Volume -->
        <div class="glass-card rounded-xl p-6 hover-lift">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-dollar-sign text-white text-sm"></i>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Total Volume</dt>
                        <dd class="text-lg font-medium text-gray-900">${{ transaction_stats.total_volume|floatformat:2 }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Active Integrations -->
        <div class="glass-card rounded-xl p-6 hover-lift">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-plug text-white text-sm"></i>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Integrations</dt>
                        <dd class="text-lg font-medium text-gray-900">{{ merchant_integrations.count }}</dd>
                    </dl>
                </div>
            </div>
        </div>

    </div>

    <!-- Quick Actions for Other Features -->
    

    <!-- Additional Quick Actions Row -->
    

    <!-- Checkout Pages Management Section -->
    <div class="glass-card rounded-xl p-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                    <i class="fas fa-shopping-cart text-orange-500 mr-2"></i>
                    Checkout Pages
                </h3>
                <p class="text-sm text-gray-500 mt-1">Create and manage your branded checkout pages</p>
            </div>
            <div class="flex space-x-2">
                <a href="{% url 'checkout:create_page' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 transition-all">
                    <i class="fas fa-plus mr-2"></i>
                    Create Page
                </a>
                <a href="{% url 'checkout:manage_pages' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-all">
                    <i class="fas fa-cog mr-2"></i>
                    Manage All
                </a>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Total Pages -->
            <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-file-alt text-white text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-500">Total Pages</p>
                        <p class="text-xl font-bold text-gray-900">{{ checkout_pages_count|default:0 }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Quick Create -->
            <div class="bg-gradient-to-r from-teal-50 to-cyan-50 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-teal-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-magic text-white text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-500">Quick Features</p>
                        <p class="text-sm text-gray-700">Multi-payment support</p>
                    </div>
                </div>
            </div>
            
            <!-- Status -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-white text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-500">Status</p>
                        <p class="text-sm text-green-600 font-medium">Ready to use</p>
                    </div>
                </div>
            </div>
        </div>
        
        {% if checkout_pages_count > 0 %}
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <p class="text-sm text-gray-600">
                    You have {{ checkout_pages_count }} checkout page{{ checkout_pages_count|pluralize }} configured
                </p>
                <a href="{% url 'checkout:manage_pages' %}" class="text-sm text-orange-600 hover:text-orange-700 font-medium">
                    View all →
                </a>
            </div>
        </div>
        {% else %}
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="text-center py-4">
                <i class="fas fa-shopping-cart text-gray-400 text-3xl mb-2"></i>
                <p class="text-sm text-gray-600 mb-3">No checkout pages created yet</p>
                <a href="{% url 'checkout:create_page' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 transition-all">
                    <i class="fas fa-plus mr-2"></i>
                    Create Your First Page
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Integration Testing Section -->
    <div class="glass-card rounded-xl p-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                    <i class="fas fa-vial text-blue-500 mr-2"></i>
                    Integration Testing
                </h3>
                <p class="text-sm text-gray-500 mt-1">Test your active integrations to ensure they're working efficiently</p>
            </div>
            <div class="flex space-x-2">
                <button onclick="refreshIntegrationStatus()" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-all">
                    <i class="fas fa-sync mr-2"></i>
                    Refresh Status
                </button>
                <a href="{% url 'integrations:integration-settings' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 transition-all">
                    <i class="fas fa-cogs mr-2"></i>
                    Manage Integrations
                </a>
            </div>
        </div>
        
        {% if merchant_integrations %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for integration in merchant_integrations %}
            {% if integration.is_enabled %}
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-200" id="integration-{{ integration.id }}">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center
                            {% if integration.integration.integration_type == 'uba_bank' or integration.integration.integration_type == 'bank' %}bg-green-100
                            {% elif integration.integration.integration_type == 'cybersource' %}bg-blue-100
                            {% elif integration.integration.integration_type == 'corefy' %}bg-purple-100
                            {% else %}bg-gray-100{% endif %}">
                            {% if integration.integration.integration_type == 'uba_bank' or integration.integration.integration_type == 'bank' %}
                                <i class="fas fa-university text-green-600"></i>
                            {% elif integration.integration.integration_type == 'cybersource' %}
                                <i class="fas fa-credit-card text-blue-600"></i>
                            {% elif integration.integration.integration_type == 'corefy' %}
                                <i class="fas fa-wallet text-purple-600"></i>
                            {% else %}
                                <i class="fas fa-plug text-gray-600"></i>
                            {% endif %}
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-gray-900">{{ integration.integration.name }}</h4>
                            <p class="text-xs text-gray-500">{{ integration.integration.provider_name }}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" title="Active"></div>
                        <span class="text-xs text-green-600 font-medium">Active</span>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <!-- Test Checkout Intent -->
                    {% if integration.integration.integration_type == 'uba_bank' or integration.integration.integration_type == 'bank' %}
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-medium text-gray-700">Checkout Test</span>
                            <span class="text-xs text-gray-500" id="test-status-{{ integration.id }}">Ready</span>
                        </div>
                        <div class="space-y-2">
                            <button onclick="openPaymentFormModal()"
                                    class="w-full inline-flex items-center justify-center px-3 py-2 border border-blue-300 text-xs font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 transition-colors"
                                    id="payment-form-btn-{{ integration.id }}">
                                <i class="fas fa-credit-card mr-1"></i>
                                Payment Test
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Integration Stats -->
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="text-center p-2 bg-blue-50 rounded">
                            <div class="font-medium text-blue-900">{{ integration.total_requests|default:0 }}</div>
                            <div class="text-blue-600">Total Requests</div>
                        </div>
                        <div class="text-center p-2 bg-green-50 rounded">
                            <div class="font-medium text-green-900">{{ integration.successful_requests|default:0 }}</div>
                            <div class="text-green-600">Successful</div>
                        </div>
                    </div>
                    
                    <!-- Last Used -->
                    <div class="text-xs text-gray-500 text-center">
                        {% if integration.last_used_at %}
                            Last used: {{ integration.last_used_at|timesince }} ago
                        {% else %}
                            Never used
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        
        <!-- Payment Form Modal -->
        <div id="payment-form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative h-full w-full bg-white">
                <div class="h-full flex flex-col">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between p-6 border-b bg-gray-50">
                        <h3 class="text-xl font-semibold text-gray-900">Payment Form Test</h3>
                        <button onclick="closePaymentFormModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-200">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Modal Content -->
                    <div class="flex-1 overflow-y-auto p-6">
                    
                    <!-- Test Mode Banner -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>
                            <div>
                                <h4 class="text-sm font-semibold text-yellow-800">Test Mode Active</h4>
                                <p class="text-sm text-yellow-700 mt-1">This is a test payment. No real charges will be made.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Form Container -->
                    <div class="flex flex-col xl:flex-row gap-8 h-full">
                        <!-- Left Column - Form Fields -->
                        <div class="flex-1">
                            <form id="payment-form" class="space-y-6">
                                <!-- Amount and Currency -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="text-md font-medium text-gray-900 mb-4">Payment Details</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="payment-currency" class="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                                            <select id="payment-currency" name="currency" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="USD">USD - US Dollar</option>
                                                <option value="EUR">EUR - Euro</option>
                                                <option value="GBP">GBP - British Pound</option>
                                                <option value="KES">KES - Kenyan Shilling</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="payment-amount" class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                                            <input type="number" id="payment-amount" name="amount" value="100.00" step="0.01" min="1" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Customer Information -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="text-md font-medium text-gray-900 mb-4">Customer Information</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="customer-first-name" class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                            <input type="text" id="customer-first-name" name="first_name" value="Test" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label for="customer-last-name" class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                            <input type="text" id="customer-last-name" name="last_name" value="User" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label for="customer-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                            <input type="email" id="customer-email" name="email" value="test@example.com" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label for="customer-phone" class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                            <input type="tel" id="customer-phone" name="phone" value="+254700000000" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Billing Address -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="text-md font-medium text-gray-900 mb-4">Billing Address</h4>
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label for="address-line1" class="block text-sm font-medium text-gray-700 mb-2">Address Line 1</label>
                                            <input type="text" id="address-line1" name="address_line1" value="Test Address Line 1" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label for="address-line2" class="block text-sm font-medium text-gray-700 mb-2">Address Line 2 (Optional)</label>
                                            <input type="text" id="address-line2" name="address_line2" value="" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="address-city" class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                                <input type="text" id="address-city" name="address_city" value="Nairobi" 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            </div>
                                            <div>
                                                <label for="address-state" class="block text-sm font-medium text-gray-700 mb-2">State/Province</label>
                                                <input type="text" id="address-state" name="address_state" value="Nairobi" 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="address-country" class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                                                <select id="address-country" name="address_country" 
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                    <option value="KE" selected>Kenya</option>
                                                    <option value="US">United States</option>
                                                    <option value="GB">United Kingdom</option>
                                                    <option value="CA">Canada</option>
                                                    <option value="AU">Australia</option>
                                                    <option value="DE">Germany</option>
                                                    <option value="FR">France</option>
                                                    <option value="NG">Nigeria</option>
                                                    <option value="ZA">South Africa</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="address-postcode" class="block text-sm font-medium text-gray-700 mb-2">Postal Code</label>
                                                <input type="text" id="address-postcode" name="address_postcode" value="00100" 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Create Payment Intent Button -->
                                <div class="flex justify-center">
                                    <button type="button" onclick="createPaymentIntent()" 
                                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                            id="create-intent-btn">
                                        <i class="fas fa-credit-card mr-2"></i>
                                        Create Payment Intent
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Right Column - Payment Widget -->
                        <div class="flex-1 min-h-0">
                            <div class="bg-gray-50 rounded-lg p-6 h-full flex flex-col">
                                <h4 class="text-lg font-medium text-gray-900 mb-6">Payment Widget</h4>
                                
                                <!-- Payment Widget Container -->
                                <div id="payment-widget-container" class="hidden flex-1">
                                    <div class="bg-white rounded-lg border-2 border-dashed border-gray-300 p-6 text-center mb-4 h-full">
                                        <div id="paydock-payment-widget" class="min-h-[500px] flex items-center justify-center">
                                            <div class="text-gray-500">
                                                <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                                                <p class="text-lg">Loading payment widget...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Placeholder -->
                                <div id="widget-placeholder" class="bg-white rounded-lg border-2 border-dashed border-gray-300 p-8 text-center flex-1 flex items-center justify-center">
                                    <div class="text-gray-500">
                                        <i class="fas fa-credit-card text-4xl mb-4"></i>
                                        <p class="text-lg">Click "Create Payment Intent" to load the payment widget</p>
                                    </div>
                                </div>
                                
                                <!-- Payment Status -->
                                <div id="payment-status" class="mt-4 hidden">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                        <div class="flex items-center">
                                            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                            <span class="text-sm text-blue-700" id="payment-status-text">Ready for payment</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div> <!-- End Modal Content -->
                </div>
            </div>
        </div>
        
        <!-- Test Results Section -->
        <div id="test-results" class="mt-6 hidden">
            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-sm font-medium text-gray-900 mb-3">Test Results</h4>
                <div id="test-results-content" class="bg-gray-50 rounded-lg p-4">
                    <!-- Test results will be populated here -->
                </div>
            </div>
        </div>
        
        {% else %}
        <div class="text-center py-8">
            <i class="fas fa-plug text-gray-300 text-3xl mb-3"></i>
            <p class="text-gray-500 mb-4">No active integrations found</p>
            <a href="{% url 'integrations:integration-settings' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 transition-all">
                <i class="fas fa-plus mr-2"></i>
                Setup Your First Integration
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Business Information & Integrations -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Business Information -->
        <div class="glass-card rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Business Information</h3>
                <button class="text-indigo-600 hover:text-indigo-700 text-sm font-medium">
                    <i class="fas fa-edit mr-1"></i>Edit
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-500">Business Name</label>
                    <p class="text-sm text-gray-900">{{ merchant.business_name }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Category</label>
                    <p class="text-sm text-gray-900">{{ merchant.category.name|default:"Not specified" }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Email</label>
                    <p class="text-sm text-gray-900">{{ merchant.business_email|default:merchant.user.email }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Phone</label>
                    <p class="text-sm text-gray-900">{{ merchant.business_phone|default:"Not provided" }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Website</label>
                    <p class="text-sm text-gray-900">
                        {% if merchant.website_url %}
                            <a href="{{ merchant.website_url }}" target="_blank" class="text-indigo-600 hover:text-indigo-700">
                                {{ merchant.website_url }}
                            </a>
                        {% else %}
                            Not provided
                        {% endif %}
                    </p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Status</label>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                        {% if merchant.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% elif merchant.status == 'approved' %}bg-green-100 text-green-800
                        {% elif merchant.status == 'active' %}bg-blue-100 text-blue-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ merchant.get_status_display }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Payment Integrations -->
        <div class="glass-card rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Payment Integrations</h3>
                <a href="{% url 'integrations:integration-settings' %}" class="text-indigo-600 hover:text-indigo-700 text-sm font-medium transition-colors">
                    <i class="fas fa-cogs mr-1"></i>Integration Settings
                </a>
            </div>
            <div class="space-y-3">
                {% for integration in merchant_integrations %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-plug text-indigo-600 text-xs"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">{{ integration.integration.name }}</p>
                            <p class="text-xs text-gray-500">{{ integration.integration.description|truncatewords:8 }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                            {% if integration.is_enabled %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {% if integration.is_enabled %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8">
                    <i class="fas fa-plug text-gray-300 text-3xl mb-3"></i>
                    <p class="text-gray-500 mb-4">No integrations configured yet</p>
                    <a href="{% url 'integrations:integration-settings' %}" class="inline-block bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Your First Integration
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent API Activity -->
    <div class="glass-card rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">Recent API Activity</h3>
            <a href="#" class="text-indigo-600 hover:text-indigo-700 text-sm font-medium">
                View all <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Integration
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Method
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Response Time
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Timestamp
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for call in recent_api_calls %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ call.integration.name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                {{ call.method|upper }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                {% if call.status == 'success' %}bg-green-100 text-green-800
                                {% elif call.status == 'error' %}bg-red-100 text-red-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {% if call.status == 'success' %}
                                    <i class="fas fa-check-circle mr-1"></i>Success
                                {% elif call.status == 'error' %}
                                    <i class="fas fa-times-circle mr-1"></i>Error
                                {% else %}
                                    <i class="fas fa-clock mr-1"></i>{{ call.status|capfirst }}
                                {% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ call.response_time|default:"--" }}ms
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ call.created_at|date:"M d, Y H:i" }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            No API activity yet
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="glass-card rounded-xl p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Actions</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors">
                <div class="text-center">
                    <i class="fas fa-key text-gray-400 text-2xl mb-2"></i>
                    <p class="text-sm font-medium text-gray-900">Generate API Keys</p>
                    <p class="text-xs text-gray-500">Create new API credentials</p>
                </div>
            </button>
            
            <button class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors">
                <div class="text-center">
                    <i class="fas fa-code text-gray-400 text-2xl mb-2"></i>
                    <p class="text-sm font-medium text-gray-900">API Documentation</p>
                    <p class="text-xs text-gray-500">View integration guides</p>
                </div>
            </button>
            
            <button class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors">
                <div class="text-center">
                    <i class="fas fa-headset text-gray-400 text-2xl mb-2"></i>
                    <p class="text-sm font-medium text-gray-900">Contact Support</p>
                    <p class="text-xs text-gray-500">Get help with integration</p>
                </div>
            </button>
        </div>
    </div>

    <!-- Test Integration Section -->
    <div class="glass-card rounded-xl p-6">
        <div class="flex items-center mb-4">
            <div class="p-3 rounded-full bg-indigo-100 mr-4">
                <i class="fas fa-code text-indigo-600 text-xl"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Test Integration</h3>
                <p class="text-sm text-gray-600">Test the payment API with your actual API key</p>
            </div>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">API Endpoint:</span>
                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">POST</span>
            </div>
            <code class="text-sm text-gray-800 bg-white px-3 py-2 rounded border block">
                http://localhost:8001/checkout/make-payment/
            </code>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Sample cURL Request:</label>
            <div class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm font-mono overflow-x-auto">
                <pre id="curl-command">curl -X POST http://localhost:8001/checkout/make-payment/ \
  -H "Authorization: Bearer <span class="text-yellow-400">{% if api_keys %}{{ api_keys.0.public_key }}:YOUR_SECRET_KEY{% else %}YOUR_API_KEY_HERE{% endif %}</span>" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 100.00,
    "currency": "USD",
    "customer_email": "test@example.com",
    "description": "Integration Test Payment",
    "callback_url": "http://localhost:8001/success",
    "cancel_url": "http://localhost:8001/cancel"
  }'</pre>
            </div>
            <div class="mt-2 flex items-center space-x-2">
                <button onclick="copyToClipboard('curl-command')" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded transition-colors">
                    <i class="fas fa-copy mr-1"></i> Copy
                </button>
                <a href="{% url 'dashboard:merchant_api_keys' %}" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded transition-colors">
                    <i class="fas fa-key mr-1"></i> Get API Key
                </a>
                {% if api_keys %}
                <button onclick="generateCompleteApiKey('{{ api_keys.0.id }}')" class="text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded transition-colors">
                    <i class="fas fa-refresh mr-1"></i> Generate Complete Key
                </button>
                {% endif %}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="text-sm font-medium text-blue-900 mb-2">
                    <i class="fas fa-info-circle mr-1"></i> Expected Response
                </h4>
                <div class="bg-white p-3 rounded border text-xs font-mono">
                    <pre>{
  "success": true,
  "payment_url": "http://localhost:8001/checkout/process-payment/?session_id=...",
  "session_id": "pay_session_...",
  "expires_at": "2024-01-01T12:00:00Z"
}</pre>
                </div>
            </div>
            
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <h4 class="text-sm font-medium text-amber-900 mb-2">
                    <i class="fas fa-exclamation-triangle mr-1"></i> Important Notes
                </h4>
                <ul class="text-xs text-amber-800 space-y-1">
                    {% if api_keys %}
                    <li>• Public key is automatically populated: <code>{{ api_keys.0.public_key }}</code></li>
                    <li>• Click "Generate Complete Key" to get both public and secret keys</li>
                    <li>• The cURL command will be automatically updated with the complete key</li>
                    <li>• Secret keys are only shown once when generated - save them securely!</li>
                    {% else %}
                    <li>• Create an API key first using the "Get API Key" button above</li>
                    <li>• Replace <code>YOUR_API_KEY_HERE</code> with your actual API key</li>
                    {% endif %}
                    <li>• API key format: <code>pk_merchant_xxx:secret_key</code></li>
                    <li>• Use HTTPS in production environments</li>
                    <li>• Store API keys securely in environment variables</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Create Transaction Modal -->
<div id="createTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-lg w-full">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-white rounded-t-2xl">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Quick Transaction</h3>
                <button onclick="closeCreateTransactionModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <form id="quickTransactionForm" class="p-6 space-y-4">
            {% csrf_token %}
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="quickAmount" class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                    <input type="number" id="quickAmount" name="amount" step="0.01" min="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                
                <div>
                    <label for="quickCurrency" class="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                    <select id="quickCurrency" name="currency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <option value="">Select...</option>
                        {% for currency in currencies %}
                        <option value="{{ currency.id }}" {% if currency.code == 'USD' %}selected{% endif %}>{{ currency.code }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div>
                <label for="quickCustomerEmail" class="block text-sm font-medium text-gray-700 mb-2">Customer Email</label>
                <input type="email" id="quickCustomerEmail" name="customer_email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            </div>
            
            <div>
                <label for="quickPaymentMethod" class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                <select id="quickPaymentMethod" name="payment_method" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    <option value="card">Card Payment</option>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="mobile_money">Mobile Money</option>
                    <option value="wallet">Digital Wallet</option>
                </select>
            </div>
            
            <div>
                <label for="quickDescription" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <input type="text" id="quickDescription" name="description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Payment description...">
            </div>
            
            <input type="hidden" name="transaction_type" value="payment">
            
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeCreateTransactionModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200">
                    Create Transaction
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Payment Link Modal -->
<div id="paymentLinkModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-lg w-full">
        <div class="bg-gradient-to-r from-green-600 to-teal-600 p-6 text-white rounded-t-2xl">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Create Payment Link</h3>
                <button onclick="closePaymentLinkModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <form id="paymentLinkForm" class="p-6 space-y-4">
            {% csrf_token %}
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="linkAmount" class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                    <input type="number" id="linkAmount" name="amount" step="0.01" min="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                </div>
                
                <div>
                    <label for="linkCurrency" class="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                    <select id="linkCurrency" name="currency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        <option value="">Select...</option>
                        {% for currency in currencies %}
                        <option value="{{ currency.id }}" {% if currency.code == 'USD' %}selected{% endif %}>{{ currency.code }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div>
                <label for="linkDescription" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <input type="text" id="linkDescription" name="description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
            </div>
            
            <div>
                <label for="linkExpiry" class="block text-sm font-medium text-gray-700 mb-2">Expiry Date (Optional)</label>
                <input type="datetime-local" id="linkExpiry" name="expires_at" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closePaymentLinkModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg hover:from-green-700 hover:to-teal-700 transition-all duration-200">
                    Create Link
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Modal functions
function openCreateTransactionModal() {
    document.getElementById('createTransactionModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeCreateTransactionModal() {
    document.getElementById('createTransactionModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    document.getElementById('quickTransactionForm').reset();
}

function openPaymentLinkModal() {
    document.getElementById('paymentLinkModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closePaymentLinkModal() {
    document.getElementById('paymentLinkModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    document.getElementById('paymentLinkForm').reset();
}

function openDocumentUploadModal() {
    document.getElementById('documentUploadModal').classList.remove('hidden');
}

function closeDocumentUploadModal() {
    document.getElementById('documentUploadModal').classList.add('hidden');
    document.getElementById('documentUploadForm').reset();
    document.getElementById('file-info').classList.add('hidden');
}

function handleFileSelect(input) {
    const file = input.files[0];
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    
    if (file) {
        fileName.textContent = file.name;
        fileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(1)} MB)`;
        fileInfo.classList.remove('hidden');
    } else {
        fileInfo.classList.add('hidden');
    }
}

// Transaction form submission
const quickTransactionForm = document.getElementById('quickTransactionForm');
if (quickTransactionForm) {
    quickTransactionForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const formData = new FormData(this);
        const response = await fetch('{% url "dashboard:create_transaction_api" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('Transaction created successfully!', 'success');
            closeCreateTransactionModal();
            setTimeout(() => {
                window.location.href = '{% url "dashboard:merchant_transactions" %}';
            }, 1000);
        } else {
            showAlert(result.error || 'Failed to create transaction', 'error');
        }
    } catch (error) {
        showAlert('Network error occurred', 'error');
    }
    });
}

// Payment link form submission
const paymentLinkForm = document.getElementById('paymentLinkForm');
if (paymentLinkForm) {
    paymentLinkForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const formData = new FormData(this);
        const response = await fetch('{% url "dashboard:create_payment_link_api" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('Payment link created successfully!', 'success');
            closePaymentLinkModal();
            showPaymentLinkResult(result.payment_url);
        } else {
            showAlert(result.error || 'Failed to create payment link', 'error');
        }
    } catch (error) {
        showAlert('Network error occurred', 'error');
    }
    });
}

// Document upload form submission
const documentUploadForm = document.getElementById('documentUploadForm');
if (documentUploadForm) {
    documentUploadForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    try {
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
        
        const response = await fetch('/dashboard/api/documents/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('Document uploaded successfully!', 'success');
            closeDocumentUploadModal();
            // Reload page to show new document
            window.location.reload();
        } else {
            showAlert(data.error || 'Upload failed', 'error');
        }
    } catch (error) {
        showAlert('Network error occurred', 'error');
    } finally {
        // Restore button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
    });
}

function deleteDocument(documentId) {
    if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
        fetch(`/dashboard/api/documents/${documentId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.ok) {
                showAlert('Document deleted successfully', 'success');
                window.location.reload();
            } else {
                showAlert('Failed to delete document', 'error');
            }
        })
        .catch(() => {
            showAlert('Network error occurred', 'error');
        });
    }
}

// Utility functions
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    alertDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
            ${message}
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function showPaymentLinkResult(paymentUrl) {
    const linkDiv = document.createElement('div');
    linkDiv.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl z-50 max-w-md w-full mx-4';
    linkDiv.innerHTML = `
        <h3 class="text-lg font-bold mb-4">Payment Link Created</h3>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Payment URL:</label>
            <div class="flex items-center space-x-2">
                <input type="text" value="${paymentUrl}" class="flex-1 px-3 py-2 border rounded-lg bg-gray-50" readonly>
                <button onclick="copyToClipboard('${paymentUrl}')" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
        <div class="flex justify-end space-x-2">
            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Close</button>
            <a href="${paymentUrl}" target="_blank" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Open Link</a>
        </div>
    `;
    
    document.body.appendChild(linkDiv);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showAlert('Copied to clipboard!', 'success');
    });
}

// Close modals on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCreateTransactionModal();
        closePaymentLinkModal();
        closeDocumentUploadModal();
    }
});

// Integration Testing Functions
function testUBACheckout(integrationId) {
    const testBtn = document.getElementById(`test-btn-${integrationId}`);
    const testStatus = document.getElementById(`test-status-${integrationId}`);
    const originalBtnText = testBtn.innerHTML;
    
    // Update UI to show testing state
    testBtn.disabled = true;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Testing...';
    testStatus.textContent = 'Testing...';
    testStatus.className = 'text-xs text-yellow-600 font-medium';
    
    // Test payload
    const testPayload = {
        integration_type: 'bank',
        test_type: 'checkout',
        amount: 100.00,
        currency: 'USD',
        customer_email: 'test@example.com',
        description: 'Integration Test Payment',
        callback_url: window.location.origin + '/test-callback',
        cancel_url: window.location.origin + '/test-cancel'
    };
    
    // Make API call to test UBA checkout
    fetch('{% url "dashboard:test_integration_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(testPayload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success
            testStatus.textContent = 'Test Passed';
            testStatus.className = 'text-xs text-green-600 font-medium';
            showTestResult({
                integration: 'UBA Bank',
                test: 'Checkout Intent',
                status: 'success',
                message: 'Checkout intent created successfully',
                data: data
            });
        } else {
            // Error
            testStatus.textContent = 'Test Failed';
            testStatus.className = 'text-xs text-red-600 font-medium';
            showTestResult({
                integration: 'UBA Bank',
                test: 'Checkout Intent',
                status: 'error',
                message: data.message || 'Test failed',
                error: data.error
            });
        }
    })
    .catch(error => {
        console.error('Test error:', error);
        testStatus.textContent = 'Test Failed';
        testStatus.className = 'text-xs text-red-600 font-medium';
        showTestResult({
            integration: 'UBA Bank',
            test: 'Checkout Intent',
            status: 'error',
            message: 'Network error occurred',
            error: error.message
        });
    })
    .finally(() => {
        // Reset button
        testBtn.disabled = false;
        testBtn.innerHTML = originalBtnText;
        
        // Reset status after 5 seconds
        setTimeout(() => {
            testStatus.textContent = 'Ready';
            testStatus.className = 'text-xs text-gray-500';
        }, 5000);
    });
}

function createTestCheckout(integrationId, integrationType) {
    const checkoutBtn = document.getElementById(`checkout-btn-${integrationId}`);
    const testStatus = document.getElementById(`test-status-${integrationId}`);
    const originalBtnText = checkoutBtn.innerHTML;
    
    // Update UI to show creating state
    checkoutBtn.disabled = true;
    checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Creating...';
    testStatus.textContent = 'Creating checkout...';
    testStatus.className = 'text-xs text-blue-600 font-medium';
    
    // Test checkout payload
    const checkoutPayload = {
        integration_type: integrationType,
        amount: 100.00,
        currency: 'USD'
    };
    
    // Make API call to create test checkout
    fetch('{% url "dashboard:create_test_checkout_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(checkoutPayload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success - open checkout page in new tab
            testStatus.textContent = 'Checkout Created';
            testStatus.className = 'text-xs text-green-600 font-medium';
            
            // Show success message with checkout URL
            showTestResult({
                integration: integrationType.toUpperCase(),
                test: 'Test Checkout Page',
                status: 'success',
                message: 'Test checkout page created successfully',
                data: {
                    checkout_url: data.data.checkout_url,
                    amount: data.data.amount,
                    currency: data.data.currency,
                    test_mode: true
                }
            });
            
            // Open checkout page in new tab after a short delay
            setTimeout(() => {
                window.open(data.data.checkout_url, '_blank');
            }, 1000);
            
        } else {
            // Error
            testStatus.textContent = 'Creation Failed';
            testStatus.className = 'text-xs text-red-600 font-medium';
            showTestResult({
                integration: integrationType.toUpperCase(),
                test: 'Test Checkout Page',
                status: 'error',
                message: data.message || 'Failed to create test checkout',
                error: data.error
            });
        }
    })
    .catch(error => {
        console.error('Checkout creation error:', error);
        testStatus.textContent = 'Creation Failed';
        testStatus.className = 'text-xs text-red-600 font-medium';
        showTestResult({
            integration: integrationType.toUpperCase(),
            test: 'Test Checkout Page',
            status: 'error',
            message: 'Network error occurred',
            error: error.message
        });
    })
    .finally(() => {
        // Reset button
        checkoutBtn.disabled = false;
        checkoutBtn.innerHTML = originalBtnText;
        
        // Reset status after 5 seconds
        setTimeout(() => {
            testStatus.textContent = 'Ready';
            testStatus.className = 'text-xs text-gray-500';
        }, 5000);
    });
}

function showTestResult(result) {
    const testResults = document.getElementById('test-results');
    const testResultsContent = document.getElementById('test-results-content');
    
    // Show test results section
    testResults.classList.remove('hidden');
    
    // Create result HTML
    const timestamp = new Date().toLocaleString();
    const statusIcon = result.status === 'success' ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500';
    const statusBg = result.status === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
    
    const resultHtml = `
        <div class="border rounded-lg p-4 mb-3 ${statusBg}">
            <div class="flex items-start justify-between mb-2">
                <div class="flex items-center">
                    <i class="fas ${statusIcon} mr-2"></i>
                    <div>
                        <h5 class="font-medium text-gray-900">${result.integration} - ${result.test}</h5>
                        <p class="text-sm text-gray-600">${timestamp}</p>
                    </div>
                </div>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                    result.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }">
                    ${result.status === 'success' ? 'Passed' : 'Failed'}
                </span>
            </div>
            <p class="text-sm text-gray-700 mb-2">${result.message}</p>
            ${result.status === 'success' && result.data ? `
                <details class="text-xs">
                    <summary class="cursor-pointer text-gray-600 hover:text-gray-800">View Response Data</summary>
                    <pre class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-x-auto">${JSON.stringify(result.data, null, 2)}</pre>
                </details>
            ` : ''}
            ${result.error ? `
                <details class="text-xs">
                    <summary class="cursor-pointer text-red-600 hover:text-red-800">View Error Details</summary>
                    <pre class="mt-2 p-2 bg-red-100 rounded text-xs overflow-x-auto">${JSON.stringify(result.error, null, 2)}</pre>
                </details>
            ` : ''}
        </div>
    `;
    
    // Prepend new result (most recent first)
    testResultsContent.innerHTML = resultHtml + testResultsContent.innerHTML;
    
    // Limit to last 5 results
    const results = testResultsContent.children;
    while (results.length > 5) {
        testResultsContent.removeChild(results[results.length - 1]);
    }
    
    // Scroll to test results
    testResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function refreshIntegrationStatus() {
    const refreshBtn = document.querySelector('button[onclick="refreshIntegrationStatus()"]');
    const originalText = refreshBtn.innerHTML;
    
    // Update button to show loading
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
    
    // Simulate refresh (you can replace this with actual API call)
    setTimeout(() => {
        // Reset button
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalText;
        
        // Show success message
        showAlert('Integration status refreshed successfully', 'success');
        
        // Optionally reload the page to get fresh data
        // window.location.reload();
    }, 2000);
}

// Auto-refresh integration status every 5 minutes
setInterval(() => {
    // You can implement automatic status checking here
    console.log('Auto-checking integration status...');
}, 300000); // 5 minutes

// Payment Form Modal Functions
function openPaymentFormModal() {
    document.getElementById('payment-form-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closePaymentFormModal() {
    document.getElementById('payment-form-modal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    
    // Reset form and widget
    resetPaymentForm();
}

function resetPaymentForm() {
    // Hide payment widget and show placeholder
    document.getElementById('payment-widget-container').classList.add('hidden');
    document.getElementById('widget-placeholder').classList.remove('hidden');
    document.getElementById('payment-status').classList.add('hidden');
    
    // Reset button
    const btn = document.getElementById('create-intent-btn');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Create Payment Intent';
    
    // Clear any existing PayDock widget
    const widgetContainer = document.getElementById('paydock-payment-widget');
    widgetContainer.innerHTML = '<div class="text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Loading payment widget...</p></div>';
}

function createPaymentIntent() {
    const btn = document.getElementById('create-intent-btn');
    const originalText = btn.innerHTML;
    
    // Update button to show loading
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Intent...';
    
    // Get form data
    const formData = {
        integration_type: 'uba_bank',
        amount: parseFloat(document.getElementById('payment-amount').value),
        currency: document.getElementById('payment-currency').value,
        customer: {
            first_name: document.getElementById('customer-first-name').value,
            last_name: document.getElementById('customer-last-name').value,
            email: document.getElementById('customer-email').value,
            phone: document.getElementById('customer-phone').value,
            billing_address: {
                first_name: document.getElementById('customer-first-name').value,
                last_name: document.getElementById('customer-last-name').value,
                address_line1: document.getElementById('address-line1').value,
                address_line2: document.getElementById('address-line2').value,
                address_city: document.getElementById('address-city').value,
                address_state: document.getElementById('address-state').value,
                address_country: document.getElementById('address-country').value,
                address_postcode: document.getElementById('address-postcode').value
            }
        }
    };
    
    // Call the UBA API to create payment intent
    fetch('/dashboard/api/test-integration/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.data && data.data.token) {
            // Initialize PayDock widget with the token
            initializePayDockWidget(data.data.token, formData);
            
            // Show payment status
            document.getElementById('payment-status').classList.remove('hidden');
            document.getElementById('payment-status-text').textContent = 'Payment intent created successfully. Complete payment below.';
            
            // Update button
            btn.innerHTML = '<i class="fas fa-check mr-2"></i>Intent Created';
            
        } else {
            throw new Error(data.message || 'Failed to create payment intent');
        }
    })
    .catch(error => {
        console.error('Error creating payment intent:', error);
        
        // Reset button
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        // Show error
        showAlert('Failed to create payment intent: ' + error.message, 'error');
    });
}

function initializePayDockWidget(token, formData) {
    // Hide placeholder and show widget container
    document.getElementById('widget-placeholder').classList.add('hidden');
    document.getElementById('payment-widget-container').classList.remove('hidden');
    
    const widgetContainer = document.getElementById('paydock-payment-widget');
    
    try {
        // Clear existing content
        widgetContainer.innerHTML = '';
        
        // Check if PayDock SDK is available
        if (typeof paydock === 'undefined') {
            // Load PayDock SDK dynamically
            const script = document.createElement('script');
            script.src = 'https://widget.paydock.com/sdk/latest/widget.umd.js';
            script.onload = () => {
                createPayDockWidget(token, formData, widgetContainer);
            };
            script.onerror = () => {
                widgetContainer.innerHTML = '<div class="text-red-500 p-4"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to load PayDock SDK</div>';
            };
            document.head.appendChild(script);
        } else {
            createPayDockWidget(token, formData, widgetContainer);
        }
        
    } catch (error) {
        console.error('Error initializing PayDock widget:', error);
        widgetContainer.innerHTML = '<div class="text-red-500 p-4"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading payment widget: ' + error.message + '</div>';
    }
}

function loadPaydockSDK() {
    console.log("%c[SDK] Loading Paydock SDK...", "color: blue");

    return new Promise((resolve, reject) => {
        if (window.paydock && typeof window.paydock.Checkout === "function") {
            console.log("%c[SDK] Paydock SDK already loaded.", "color: green");
            return resolve();
        }

        const script = document.createElement("script");
        script.src = "https://widget.paydock.com/sdk/latest/widget.umd.min.js";
        script.onload = () => {
            console.log("%c[SDK] Paydock SDK loaded successfully.", "color: green");
            if (window.paydock && typeof window.paydock.Checkout === "function") {
                resolve();
            } else {
                console.error(
                    "[SDK] Paydock Checkout object not found after loading SDK.",
                    window.paydock
                );
                reject(
                    new Error("Paydock Checkout object not found after loading SDK.")
                );
            }
        };
        script.onerror = () => {
            console.error("[SDK] Failed to load Paydock SDK.", "color: red");
            reject(new Error("Failed to load Paydock SDK."));
        };

        document.head.appendChild(script);
    });
}

async function createPayDockWidget(token, formData, container) {
    try {
        await loadPaydockSDK();

        if (!window.paydock || typeof window.paydock.Checkout !== "function") {
            handlePaymentError("Paydock SDK is not correctly loaded or is incompatible.");
            return;
        }

        if (!token) {
            console.error("[Widget] FATAL: Intent token missing.");
            handlePaymentError("Payment session data is missing. Please refresh the page.");
            return;
        }

        console.log(
            "%c[Widget] Initializing Paydock widget with intent token: " + token,
            "color: blue"
        );

        // Clear existing content
        container.innerHTML = '';
        
        // Create widget container
        const widgetDiv = document.createElement('div');
        widgetDiv.id = 'paydock-checkout-widget';
        widgetDiv.style.minHeight = '400px';
        container.appendChild(widgetDiv);

        // Debug: Check if Paydock object exists
        console.log("Paydock object:", window.paydock);
        console.log("Paydock Checkout constructor:", window.paydock?.Checkout);
        
        try {
            window.kpsPaydockWidget = new window.paydock.Checkout(
                "#paydock-checkout-widget",
                token
            );

            console.log("Widget instance created:", window.kpsPaydockWidget);

            // Set environment
            if (typeof window.kpsPaydockWidget.setEnv === "function") {
                window.kpsPaydockWidget.setEnv("sandbox"); // Always use sandbox for testing
            }

            // Handle successful payment
            if (typeof window.kpsPaydockWidget.onPaymentSuccessful === "function") {
                window.kpsPaydockWidget.onPaymentSuccessful(function (data) {
                    console.log("Payment successful:", data);
                    
                    // Update status
                    document.getElementById('payment-status-text').textContent = 'Payment completed successfully!';
                    document.getElementById('payment-status').className = 'mt-4 bg-green-50 border border-green-200 rounded-lg p-3';
                    document.getElementById('payment-status').querySelector('i').className = 'fas fa-check-circle text-green-500 mr-2';
                    
                    // Show success message
                    showAlert('Payment completed successfully!', 'success');
                    
                    // Auto-close modal after 3 seconds
                    setTimeout(() => {
                        closePaymentFormModal();
                    }, 3000);
                });
            }

            // Handle payment failure
            if (typeof window.kpsPaydockWidget.onPaymentFailure === "function") {
                window.kpsPaydockWidget.onPaymentFailure(function (error) {
                    console.error("Payment failure:", error);
                    handlePaymentError(error.message || "An error occurred during payment.");
                });
            }

            // Handle payment expiration
            if (typeof window.kpsPaydockWidget.onPaymentExpired === "function") {
                window.kpsPaydockWidget.onPaymentExpired(function (error) {
                    console.error("Payment expired:", error);
                    handlePaymentError(error.message || "Your payment session has expired. Please retry.");
                });
            }

            // Post-initialization check to see if iframe exists after a short delay
            setTimeout(() => {
                const iframe = container.querySelector("iframe");
                if (iframe) {
                    console.log(
                        "%c[Widget] SUCCESS: Iframe injected by Paydock.",
                        "color: green; font-weight: bold;"
                    );
                } else {
                    console.error(
                        "%c[Widget] FAILURE: Iframe was NOT injected by Paydock.",
                        "color: red; font-weight: bold;"
                    );
                    console.log("Container content:", container.innerHTML);
                    // Show fallback form if widget fails to render
                    showFallbackPaymentForm(formData, container);
                }
            }, 3000);
            
        } catch (widgetError) {
            console.error("Error creating Paydock widget:", widgetError);
            handlePaymentError("Failed to create payment widget: " + widgetError.message);
        }
        
    } catch (error) {
        console.error("[Init] Critical failure during widget init:", error);
        handlePaymentError("A critical error occurred: " + error.message);
    }
}

function handlePaymentError(message) {
    const container = document.getElementById('paydock-payment-widget');
    if (container) {
        container.style.display = 'block';
        container.style.visibility = 'visible';
        container.style.height = 'auto';
        container.style.border = '1px solid #fca5a5';
        
        container.innerHTML = `
            <div class="widget-error" style="padding: 1rem; margin-top: 1rem; color: #b91c1c; background-color: #fee2e2; border: 1px solid #fca5a5; border-radius: 0.5rem;">
                <strong>Error:</strong> ${message}<br>Please try again or contact support.
            </div>
        `;
    }
    
    // Update payment status
    const statusElement = document.getElementById('payment-status-text');
    if (statusElement) {
        statusElement.textContent = 'Payment failed: ' + message;
        document.getElementById('payment-status').className = 'mt-4 bg-red-50 border border-red-200 rounded-lg p-3';
        document.getElementById('payment-status').querySelector('i').className = 'fas fa-exclamation-triangle text-red-500 mr-2';
    }
    
    showAlert('Payment failed: ' + message, 'error');
}

function showFallbackPaymentForm(formData, container) {
    container.innerHTML = `
        <div class="bg-white p-6 rounded-lg border">
            <h5 class="text-lg font-medium mb-4">Test Payment Form</h5>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Card Number</label>
                    <input type="text" placeholder="4111 1111 1111 1111" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Expiry</label>
                        <input type="text" placeholder="MM/YY" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">CVV</label>
                        <input type="text" placeholder="123" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <button type="button" onclick="simulatePayment()" 
                        class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                    Complete Test Payment (${formData.currency} ${formData.amount})
                </button>
            </div>
        </div>
    `;
}

function simulatePayment() {
    // Simulate a successful payment for testing
    setTimeout(() => {
        // Update status
        document.getElementById('payment-status-text').textContent = 'Test payment completed successfully!';
        document.getElementById('payment-status').className = 'mt-4 bg-green-50 border border-green-200 rounded-lg p-3';
        document.getElementById('payment-status').querySelector('i').className = 'fas fa-check-circle text-green-500 mr-2';
        
        showAlert('Test payment completed successfully!', 'success');
        
        // Auto-close modal after 3 seconds
        setTimeout(() => {
            closePaymentFormModal();
        }, 3000);
    }, 2000);
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('payment-form-modal');
    if (event.target === modal) {
        closePaymentFormModal();
    }
});

// Copy to clipboard function for Test Integration section
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent || element.innerText;
    
    // Create a temporary textarea to copy the text
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    
    // Show feedback
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check mr-1"></i> Copied!';
    button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    button.classList.add('bg-green-600');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('bg-green-600');
        button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    }, 2000);
}

// Generate complete API key function
function generateCompleteApiKey(keyId) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Generating...';
    button.disabled = true;
    
    // Call the regenerate API endpoint
    fetch(`/dashboard/api/api-keys/${keyId}/regenerate/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the cURL command with the complete API key
            const curlElement = document.getElementById('curl-command');
            const curlText = curlElement.textContent;
            
            // Replace the API key in the Authorization header
            const updatedCurl = curlText.replace(
                /Authorization: Bearer [^"]+/,
                `Authorization: Bearer ${data.full_key}`
            );
            
            curlElement.textContent = updatedCurl;
            
            // Show success message
            button.innerHTML = '<i class="fas fa-check mr-1"></i> Generated!';
            button.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            button.classList.add('bg-green-600');
            
            // Show alert with the complete key
            alert(`Complete API Key Generated`)
        } else {
            button.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> Error';
            button.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            button.classList.add('bg-red-600');
            alert('Error generating API key: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> Error';
        button.classList.remove('bg-orange-600', 'hover:bg-orange-700');
        button.classList.add('bg-red-600');
        alert('Error generating API key: ' + error.message);
    })
    .finally(() => {
        // Reset button after 3 seconds
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('bg-green-600', 'bg-red-600');
            button.classList.add('bg-orange-600', 'hover:bg-orange-700');
            button.disabled = false;
        }, 3000);
    });
}

</script>
{% endblock %}
